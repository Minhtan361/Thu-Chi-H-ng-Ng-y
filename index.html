<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ªï Thu Chi H√†ng Ng√†y</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* ========================================= */
        /* 1. CSS N√¢ng C·∫•p Giao Di·ªán (Mobile First) */
        /* ========================================= */
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --bg-light: #ecf0f1;
            --text-dark: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent; /* Lo·∫°i b·ªè highlight khi ch·∫°m */
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px; /* Gi·∫£m padding cho mobile */
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 15px 10px;
            text-align: center;
            border-radius: 8px; /* Gi·∫£m bo g√≥c */
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #welcomeMessage {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 20px; /* TƒÉng k√≠ch th∆∞·ªõc n√∫t */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 15px;
            width: 100%; /* Full width tr√™n mobile */
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-zalo { background-color: #0088ff; color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: var(--text-dark); }
        .btn-sm { padding: 8px 12px; font-size: 13px; width: auto; margin: 3px; }
        
        /* Cards */
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 15px; /* Gi·∫£m padding cho mobile */
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--primary-color);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-dark);
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
            outline: none;
        }

        input[readonly] {
            background-color: #f9f9f9;
            font-weight: bold;
            color: var(--text-dark);
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -5px; /* Gi·∫£m margin √¢m */
        }
        
        .col {
            flex: 1 1 100%; /* 100% chi·ªÅu r·ªông tr√™n mobile */
            padding: 0 5px;
            min-width: 0; 
        }

        /* Responsive for Desktop/Tablet */
        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }
            .col {
                flex: 1;
                padding: 0 12px;
                min-width: 300px;
            }
            .btn {
                width: auto;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Login */
        .login-container {
            max-width: 400px; /* Gi·∫£m max-width */
            margin: 50px auto;
            padding: 25px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        /* Notes (Ghi ch√∫) */
        .note {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
            margin-bottom: 10px;
        }
        
        /* Expense list style */
        .expense-item {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }
        .expense-item input[type="text"]:first-child {
            flex: 2;
        }
        .expense-item input[type="text"]:nth-child(2) {
            flex: 1;
            min-width: 100px;
        }
        .expense-item .btn-danger {
            width: 40px;
            height: 40px;
            padding: 0;
            margin: 0;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .add-expense-btn {
            margin-top: 10px;
        }

        /* Date Selector for employee */
        .date-selector-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }
        .date-selector-container input[type="date"] {
            width: 100%;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .action-buttons {
                flex-direction: row;
                justify-content: flex-end;
            }
            .date-selector-container {
                flex-direction: row;
                align-items: center;
            }
        }
        
        /* Admin Report Table */
        #adminReportTable {
            border-collapse: collapse;
            font-size: 13px;
        }

        #adminReportTable thead th {
            padding: 8px;
        }

        #adminReportTable tbody td {
            padding: 8px;
            border-bottom: 1px solid #ecf0f1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Ch·ªânh s·ª≠a layout cho Staff Discount */
        .staff-discount-item {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .staff-discount-item > div {
            flex: 1;
        }
        .discount-result {
            padding: 12px;
            border: 1px dashed #2ecc71;
            border-radius: 6px;
            font-weight: bold;
            text-align: right;
            background-color: #f7fcf7;
            font-size: 16px;
            min-height: 43px; /* ƒê·∫£m b·∫£o chi·ªÅu cao nh∆∞ input */
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* Employee list for Admin */
        .employee-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }

        .employee-row:last-child {
            border-bottom: none;
        }
        
    </style>
</head>
<body>

    <div id="loginBlock" class="login-container">
        <h2 class="login-title">ƒêƒÉng Nh·∫≠p ·ª®ng D·ª•ng</h2>
        <div class="form-group">
            <label for="employeeSelect">Ch·ªçn t√™n c·ªßa b·∫°n (Nh√¢n vi√™n):</label>
            <select id="employeeSelect">
                </select>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" onclick="login()">ƒêƒÉng Nh·∫≠p Thu Ng√¢n</button>
        </div>
        
        <div class="admin-login" style="margin-top: 30px;">
            <h4 style="margin-bottom: 15px; color: #7f8c8d;">--- Qu·∫£n tr·ªã vi√™n ---</h4>
            <div class="form-group">
                <label for="adminPassword">M·∫≠t kh·∫©u Admin:</label>
                <input type="password" id="adminPassword" placeholder="M·∫≠t kh·∫©u">
            </div>
            <button class="btn btn-warning" onclick="adminLogin()">ƒêƒÉng Nh·∫≠p Admin</button>
        </div>
    </div>

    <div id="appContainer" class="container hidden">
        <header>
            <div class="user-info">
                <span id="welcomeMessage"></span>
            </div>
            <button class="btn btn-danger btn-sm" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
        </header>

        <div id="syncStatus" style="text-align: center; padding: 10px; margin-bottom: 15px; border-radius: 6px; background-color: #95a5a6; color: white;">
            Offline
        </div>
        
        <div class="card" id="adminReportManagement" style="display:none;">
            <h3 class="card-title" style="color: var(--danger-color); border-left: 5px solid var(--danger-color);">QU·∫¢N L√ù B√ÅO C√ÅO</h3>
            
            <div class="card" id="adminEmployeeManagement" style="border-left: 5px solid #2980b9;">
                <h3 class="card-title" style="color: #2980b9;">QU·∫¢N L√ù NH√ÇN VI√äN THU NG√ÇN</h3>
                <div class="form-group">
                    <label for="newEmployeeName">T√™n Thu ng√¢n m·ªõi:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newEmployeeName" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn X" style="flex: 1;">
                        <button class="btn btn-primary btn-sm" onclick="addEmployee()" style="width: auto;">Th√™m</button>
                    </div>
                </div>
                <h4 style="margin-top: 15px; margin-bottom: 10px;">Danh s√°ch hi·ªán t·∫°i:</h4>
                <div id="employeeListAdmin">
                    </div>
            </div>

            <h3 class="card-title" style="margin-top: 20px;">XEM & CH·ªàNH S·ª¨A B√ÅO C√ÅO</h3>
            <div style="margin-bottom: 20px;">
                <label for="dateSelectAdmin">Ch·ªçn ng√†y ƒë·ªÉ xem/s·ª≠a:</label>
                <div class="date-selector-container">
                    <input type="date" id="dateSelectAdmin" onchange="loadDataToForm(true)">
                    <button class="btn btn-primary" onclick="loadDataToForm(true)">T·∫£i d·ªØ li·ªáu</button>
                </div>
            </div>

            <h4 style="margin-bottom: 10px; color: var(--primary-color);">Danh s√°ch ng√†y ƒë√£ ghi ch√©p</h4>
            <div style="overflow-x: auto;">
                <table id="adminReportTable" style="width:100%; min-width: 400px;">
                    <thead>
                        <tr style="background:#3498db; color:#fff;">
                            <th style="width: 15%; padding: 8px;">Ng√†y</th>
                            <th style="width: 20%; padding: 8px;">Nh√¢n vi√™n</th>
                            <th style="width: 35%; padding: 8px;">Th·ªùi gian nh·∫≠p cu·ªëi</th> 
                            <th style="width: 30%; padding: 8px;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="adminReportTableBody">
                        </tbody>
                </table>
            </div>

            <div style="margin-top:20px;">
                <h4 style="margin-bottom: 10px;">T·∫£i b√°o c√°o Excel (T·ªïng h·ª£p)</h4>
                <div class="date-selector-container">
                    <label>T·ª´ ng√†y:</label>
                    <input type="date" id="startDateAdmin">
                    <label>ƒê·∫øn ng√†y:</label>
                    <input type="date" id="endDateAdmin">
                    <button class="btn btn-warning" onclick="exportReportsByDateRange()" id="exportBtn">T·∫£i b√°o c√°o Excel</button>
                </div>
            </div>
        </div>

        <div id="dataEntryForm" class="hidden">
            <div class="card">
                <div class="date-selector-container" style="margin-bottom: 15px;">
                    <label for="selectedDate">Ng√†y l√†m vi·ªác:</label>
                    <input type="date" id="selectedDate" onchange="loadDataToForm(isAdmin)">
                    <button class="btn btn-primary btn-sm" onclick="loadDataToForm(isAdmin)">T·∫£i d·ªØ li·ªáu</button>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="card">
                        <h3 class="card-title">I. PH·∫¶N THU (DOANH THU & TI·ªÄN M·∫∂T)</h3>
                        <div class="form-group">
                            <label for="revenue">1. Doanh thu (T·ªïng ti·ªÅn h√†ng):</label>
                            <input type="text" id="revenue" value="0" oninput="formatAndCalculate(this)">
                            <small class="note">T·ªïng gi√° tr·ªã h√≥a ƒë∆°n ƒë√£ b√°n trong ca.</small>
                        </div>
                        <div class="form-group">
                            <label for="cash">2. Ti·ªÅn m·∫∑t (Kh√°ch tr·∫£ ti·ªÅn m·∫∑t):</label>
                            <input type="text" id="cash" value="0" oninput="formatAndCalculate(this)">
                            <small class="note">S·ªë ti·ªÅn m·∫∑t th·ª±c t·∫ø nh·∫≠n t·ª´ kh√°ch.</small>
                        </div>
                        <div class="form-group">
                            <label for="transfer">3. Chuy·ªÉn kho·∫£n (Kh√°ch chuy·ªÉn kho·∫£n):</label>
                            <input type="text" id="transfer" value="0" oninput="formatAndCalculate(this)">
                            <small class="note">T·ªïng s·ªë ti·ªÅn kh√°ch chuy·ªÉn kho·∫£n tr·ª±c ti·∫øp v√†o t√†i kho·∫£n.</small>
                        </div>
                        
                        <hr style="margin: 20px 0;">
                        
                        <h3 class="card-title" style="border-left: 5px solid var(--success-color); padding-left: 10px;">T·ªîNG THU</h3>
                        <div class="form-group">
                            <label>T·ªîNG THU (Ti·ªÅn m·∫∑t + Chuy·ªÉn kho·∫£n):</label>
                            <input type="text" id="totalIncome" value="0" readonly>
                            <small class="note">Ti·ªÅn m·∫∑t th·ª±c nh·∫≠n + Ti·ªÅn chuy·ªÉn kho·∫£n th·ª±c nh·∫≠n (ch∆∞a bao g·ªìm Apps).</small>
                        </div>

                        <h3 class="card-title">II. APPS (Shoppe, Grab, Bee)</h3>
                        <div class="form-group">
                            <label for="shoppeFood">Shoppe Food (Ti·ªÅn kh√°ch tr·∫£ tr√™n App):</label>
                            <input type="text" id="shoppeFood" value="0" oninput="formatAndCalculate(this)">
                        </div>
                        <div class="form-group">
                            <label for="grabFood">Grab Food (Ti·ªÅn kh√°ch tr·∫£ tr√™n App):</label>
                            <input type="text" id="grabFood" value="0" oninput="formatAndCalculate(this)">
                        </div>
                        <div class="form-group">
                            <label for="beeFood">Bee Food (Ti·ªÅn kh√°ch tr·∫£ tr√™n App):</label>
                            <input type="text" id="beeFood" value="0" oninput="formatAndCalculate(this)">
                        </div>
                        <div class="form-group">
                            <label>T·ªîNG APPS:</label>
                            <input type="text" id="totalApps" value="0" readonly>
                            <small class="note">T·ªïng doanh thu t·ª´ t·∫•t c·∫£ c√°c ·ª©ng d·ª•ng giao h√†ng.</small>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="card">
                        <h3 class="card-title">III. PH·∫¶N CHI (TI·ªÄN M·∫∂T)</h3>
                        <div id="expenseList">
                            </div>
                        <button class="btn btn-primary add-expense-btn" onclick="addExpenseItem()">‚ûï Th√™m m·ª•c chi</button>
                        
                        <hr style="margin: 20px 0;">
                        
                        <h3 class="card-title" style="border-left: 5px solid var(--danger-color); padding-left: 10px;">T·ªîNG CHI</h3>
                        <div class="form-group">
                            <label>T·ªîNG CHI (T·ªïng c·ªông c√°c m·ª•c chi ti·ªÅn m·∫∑t):</label>
                            <input type="text" id="totalExpense" value="0" readonly>
                            <small class="note">T·ªïng ti·ªÅn m·∫∑t chi ra cho c√°c ho·∫°t ƒë·ªông trong ca.</small>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">IV. GI·∫¢M GI√Å NH√ÇN VI√äN (15%)</h3>
                        <div class="form-group">
                            <label for="staffName">T√™n Nh√¢n vi√™n:</label>
                            <input type="text" id="staffName" placeholder="T√™n nh√¢n vi√™n h∆∞·ªüng gi·∫£m gi√°">
                            <small class="note">Nh·∫≠p t√™n ƒë·ªÉ ghi ch√∫ trong b√°o c√°o.</small>
                        </div>
                        <div class="staff-discount-item">
                            <div style="flex: 2;">
                                <label for="staffBill">Gi√° tr·ªã H√≥a ƒë∆°n:</label>
                                <input type="text" id="staffBill" value="0" oninput="calculateStaffDiscount(this)">
                            </div>
                            <div style="flex: 1;">
                                <label>Gi·∫£m gi√° (15%):</label>
                                <div class="discount-result" id="staffDiscountAmount">0</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="staffDiscount">T·ªïng Gi·∫£m gi√° (Gi√° tr·ªã tr·ª´ ra):</label>
                            <input type="text" id="staffDiscount" value="0" readonly>
                            <small class="note">S·ªë ti·ªÅn gi·∫£m tr·ª´ v√†o doanh thu (15% c·ªßa h√≥a ƒë∆°n). **Kh√¥ng t√≠nh v√†o T·ªïng k·∫øt cu·ªëi c√πng.**</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="border-left: 5px solid var(--warning-color);">
                <h3 class="card-title">V. T·ªîNG K·∫æT & TI·ªÄN M·∫∂T TH·ª∞C NH·∫¨N</h3>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>ƒê·∫ßu ca (Ti·ªÅn m·∫∑t c·ªë ƒë·ªãnh):</label>
                            <input type="text" id="openingCash" value="500,000" readonly>
                            <small class="note">Ti·ªÅn m·∫∑t c·ªë ƒë·ªãnh ƒë∆∞·ª£c nh·∫≠n v√†o ƒë·∫ßu ca ($500.000).</small>
                        </div>
                        <div class="form-group">
                            <label for="otherIncome">Thu kh√°c (Ngo√†i doanh thu, n·∫øu c√≥):</label>
                            <input type="text" id="otherIncome" value="0" oninput="formatAndCalculate(this)">
                            <small class="note">C√°c kho·∫£n thu ngo√†i doanh thu b√°n h√†ng (v√≠ d·ª•: ti·ªÅn c·ªçc, thu h·ªìi n·ª£).</small>
                        </div>
                        <div class="form-group">
                            <label style="color: #2980b9;">T·ªîNG NH·∫¨N T√ÄI KHO·∫¢N (Chuy·ªÉn kho·∫£n + Apps):</label>
                            <input type="text" id="totalReceived" value="0" readonly style="color: #2980b9;">
                            <small class="note">T·ªïng s·ªë ti·ªÅn s·∫Ω nh·∫≠n ƒë∆∞·ª£c v√†o T√†i kho·∫£n Ng√¢n h√†ng (CK kh√°ch tr·∫£ + T·ªïng Apps).</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>T·ªîNG TI·ªÄN M·∫∂T HI·ªÜN C√ì (Ti·ªÅn m·∫∑t thu):</label>
                            <input type="text" id="totalAfterOpening" value="0" readonly>
                            <small class="note">**TI·ªÄN M·∫∂T THU** th·ª±c t·∫ø t·ª´ kh√°ch.</small>
                        </div>
                        <div class="form-group">
                            <label style="color: #1e8449;">TI·ªÄN M·∫∂T C·∫¶N C√ì (CU·ªêI CA):</label>
                            <input type="text" id="actualTotal" value="0" readonly style="color: #1e8449;">
                            <small class="note">S·ªë ti·ªÅn m·∫∑t c√≤n l·∫°i sau khi tr·ª´ ti·ªÅn ƒë·∫ßu ca. C√¥ng th·ª©c: (Ti·ªÅn m·∫∑t thu) - (ƒê·∫ßu ca).</small>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 30px; padding-top: 15px; border-top: 2px solid #ddd;">
                    <label style="color: var(--danger-color); font-size: 18px;">T·ªîNG THU NH·∫¨P:</label>
                    <input type="text" id="totalIncomeFinalInput" value="0" readonly style="color: var(--danger-color); font-weight: bold; background-color: #fcebeb !important; border: 3px solid var(--danger-color) !important; font-size: 24px !important; height: 50px !important;">
                    <small class="note" style="font-size: 14px; font-weight: bold;">C√¥ng th·ª©c: Ti·ªÅn m·∫∑t + Chuy·ªÉn kho·∫£n + Apps + Thu kh√°c + T·ªïng Chi.</small>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--success-color); font-size: 18px; font-weight: bold;">T·ªîNG NH·∫¨N SAU C√ÅC CHI PH√ç:</label>
                    <input type="text" id="totalAfterExpensesInput" value="0" readonly style="color: var(--success-color); font-weight: bold; background-color: #eaf7ed !important; border: 3px solid var(--success-color) !important; font-size: 24px !important; height: 50px !important;">
                    <small class="note" style="font-size: 14px; font-weight: bold;">C√¥ng th·ª©c: T·ªîNG THU NH·∫¨P - T·ªïng Chi - ƒê·∫ßu ca.</small>
                </div>
                </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveAndExport()">L∆∞u v√† Xu·∫•t ·∫¢nh</button>
                <button class="btn btn-danger" onclick="clearDataForDate()" id="clearDateBtn">X√≥a d·ªØ li·ªáu ng√†y n√†y</button>
            </div>
        </div>

        <div id="exportImageContainer" class="export-image-container hidden" style="margin-top: 20px;">
            <div id="reportContent" style="background: white; margin-bottom: 15px; overflow-x: auto;">
                </div>
            <img id="exportedImage" src="" alt="B√°o c√°o thu chi" style="max-width: 100%; height: auto; display: none;">
            <div style="margin-top: 20px;" class="action-buttons">
                <button class="btn btn-zalo" onclick="shareViaZalo()" id="zaloShareBtn">üì§ Chia s·∫ª B√°o c√°o qua Zalo</button>
                <button class="btn btn-primary" onclick="downloadImage()">T·∫£i ·∫£nh xu·ªëng</button>
                <button class="btn btn-danger" onclick="hideExportImage()">ƒê√≥ng</button>
            </div>
        </div>

    </div>

    <script>
        // C·∫•u h√¨nh Firebase C·ª¶A B·∫†N ƒê√É C·∫¨P NH·∫¨T
        const firebaseConfig = {
             apiKey: "AIzaSyBI6gADn7OPIJbK3x4tu69Zh5eRLoXO_zs",
             authDomain: "minhtan-d6ecd.firebaseapp.com",
             projectId: "minhtan-d6ecd",
             storageBucket: "minhtan-d6ecd.firebasestorage.app",
             messagingSenderId: "490270665555",
             appId: "1:490270665555:web:7df829b497cf0985448fa6",
        };
        
        // M·∫≠t kh·∫©u Admin KH√îNG N√äN L∆ØU TRONG CLIENT-SIDE. D√πng t·∫°m ƒë·ªÉ test.
        const ADMIN_PASSWORD = 'thaithae2025@';

        // Kh·ªüi t·∫°o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        
        let currentUser = '';
        let isAdmin = false;
        let expenseCount = 0;
        const OPENING_CASH = 500000; // 500.000 VNƒê
        let employees = []; // Danh s√°ch nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ Firebase

        // --- H√ÄM TI·ªÜN √çCH ---

        function parseCurrency(value) {
            if (!value) return 0;
            return parseFloat(value.toString().replace(/[^0-9-]/g, '')) || 0;
        }

        function formatNumber(number) {
            if (typeof number !== 'number' || isNaN(number)) return '0';
            return number.toLocaleString('en-US');
        }
        
        const getDayOfWeek = (dateString) => {
            const days = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
            // C·∫ßn parse ƒë√∫ng ƒë·ªãnh d·∫°ng YYYY-MM-DD v√† d√πng UTC ƒë·ªÉ tr√°nh l·ªách m√∫i gi·ªù
            const date = new Date(dateString + 'T00:00:00Z');
            return days[date.getUTCDay()]; 
        };

        function formatAndCalculate(input) {
            const num = parseCurrency(input.value);
            input.value = formatNumber(num);
            calculateTotals();
        }

        function calculateStaffDiscount(input) {
            const billInput = document.getElementById('staffBill');
            const billValue = parseCurrency(billInput.value);
            
            const discountRate = 0.15;
            const discountAmount = Math.round(billValue * discountRate);
            
            document.getElementById('staffDiscountAmount').textContent = formatNumber(discountAmount);
            document.getElementById('staffDiscount').value = formatNumber(discountAmount);

            billInput.value = formatNumber(billValue);
            
            calculateTotals();
        }

        // --- H√ÄM T√çNH TO√ÅN CH√çNH (C·∫¨P NH·∫¨T C√îNG TH·ª®C THEO Y√äU C·∫¶U) ---

        function calculateTotals() {
            // L·∫•y input
            const revenue = parseCurrency(document.getElementById('revenue').value);
            const cash = parseCurrency(document.getElementById('cash').value);
            const transfer = parseCurrency(document.getElementById('transfer').value);
            const otherIncome = parseCurrency(document.getElementById('otherIncome').value);
            
            const totalIncome = cash + transfer;
            document.getElementById('totalIncome').value = formatNumber(totalIncome);

            // 2. Apps
            const shoppeFood = parseCurrency(document.getElementById('shoppeFood').value);
            const grabFood = parseCurrency(document.getElementById('grabFood').value);
            const beeFood = parseCurrency(document.getElementById('beeFood').value);
            const totalApps = shoppeFood + grabFood + beeFood;
            document.getElementById('totalApps').value = formatNumber(totalApps);

            // 3. Chi
            let totalExpense = 0;
            for (let i = 1; i <= expenseCount; i++) {
                const valueElement = document.getElementById(`expenseValue-${i}`);
                if (valueElement) {
                    totalExpense += parseCurrency(valueElement.value);
                }
            }
            document.getElementById('totalExpense').value = formatNumber(totalExpense);

            // 4. Gi·∫£m gi√° nh√¢n vi√™n (CH·ªà GHI NH·∫¨N, KH√îNG T√çNH V√ÄO T·ªîNG K·∫æT)
            const staffDiscount = parseCurrency(document.getElementById('staffDiscount').value);

            // K·∫æT QU·∫¢ CU·ªêI C√ôNG
            const totalReceived = transfer + totalApps;
            document.getElementById('totalReceived').value = formatNumber(totalReceived);
            
            // 1. T·ªîNG THU NH·∫¨P (C√¥ng th·ª©c: Ti·ªÅn m·∫∑t + Chuy·ªÉn kho·∫£n + Apps + Thu kh√°c + T·ªïng Chi)
            const totalIncomeFinal = totalIncome + totalApps + otherIncome + totalExpense; 
            document.getElementById('totalIncomeFinalInput').value = formatNumber(totalIncomeFinal);

            // 2. T·ªîNG NH·∫¨N SAU C√ÅC CHI PH√ç (C√¥ng th·ª©c m·ªõi: T·ªîNG THU NH·∫¨P - T·ªïng Chi - ƒê·∫ßu ca)
            const totalAfterExpenses = totalIncomeFinal - totalExpense - OPENING_CASH;
            document.getElementById('totalAfterExpensesInput').value = formatNumber(totalAfterExpenses);
            
            /* --- C·∫¨P NH·∫¨T C√îNG TH·ª®C T√çNH TI·ªÄN M·∫∂T THEO Y√äU C·∫¶U M·ªöI --- */
            
            // T·ªîNG TI·ªÄN M·∫∂T HI·ªÜN C√ì: Ch·ªâ l·∫•y Ti·ªÅn m·∫∑t thu (cash)
            const totalAfterOpening = cash; 
            document.getElementById('totalAfterOpening').value = formatNumber(totalAfterOpening);

            // TI·ªÄN M·∫∂T C·∫¶N C√ì (CU·ªêI CA): Ti·ªÅn m·∫∑t hi·ªán c√≥ (m·ªõi) - ƒê·∫ßu ca
            const actualTotal = totalAfterOpening - OPENING_CASH;
            document.getElementById('actualTotal').value = formatNumber(actualTotal);
        }

        // --- QU·∫¢N L√ù FORM CHI ---

        function addExpenseItem(content = '', value = 0, isInitial = false) {
            expenseCount++;
            const expenseList = document.getElementById('expenseList');
            
            const div = document.createElement('div');
            div.className = 'expense-item';
            div.id = `expenseItem-${expenseCount}`;
            
            // Cho ph√©p th√™m / x√≥a m·ª•c chi linh ho·∫°t
            const deleteButtonHtml = `<button class="btn btn-danger btn-sm" onclick="removeExpenseItem(${expenseCount})">X</button>`;
            
            div.innerHTML = `
                <input type="text" id="expenseContent-${expenseCount}" placeholder="N·ªôi dung chi (vd: Mua nguy√™n li·ªáu)" value="${content}">
                <input type="text" id="expenseValue-${expenseCount}" value="${formatNumber(value)}" oninput="formatAndCalculate(this)">
                ${deleteButtonHtml}
            `;
            
            expenseList.appendChild(div);
            // Re-attach event listener for new input
            document.getElementById(`expenseValue-${expenseCount}`).addEventListener('input', () => formatAndCalculate(document.getElementById(`expenseValue-${expenseCount}`)));
            
            // Ch·ªâ t√≠nh to√°n khi kh√¥ng ph·∫£i ƒëang kh·ªüi t·∫°o 5 m·ª•c r·ªóng
            if(!isInitial) {
                 calculateTotals();
            }
        }

        function removeExpenseItem(id) {
            const item = document.getElementById(`expenseItem-${id}`);
            if (item) {
                item.remove();
                calculateTotals();
            }
        }
        
        function initExpenseItems() {
            const expenseList = document.getElementById('expenseList');
            expenseList.innerHTML = '';
            expenseCount = 0;
            // Kh·ªüi t·∫°o 5 m·ª•c chi r·ªóng ban ƒë·∫ßu, c√≥ n√∫t X
            for (let i = 0; i < 5; i++) {
                addExpenseItem('', 0, false);
            }
        }
        
        // --- QU·∫¢N L√ù NH√ÇN VI√äN (M·ªöI) ---
        
        async function loadEmployees() {
            try {
                const doc = await db.collection('config').doc('employees').get();
                if (doc.exists) {
                    employees = doc.data().list || [];
                } else {
                    // M·∫∑c ƒë·ªãnh ban ƒë·∫ßu n·∫øu ch∆∞a c√≥ data
                    employees = ['Nguy·ªÖn VƒÉn A', 'Tr·∫ßn Th·ªã B', 'L√™ VƒÉn C'];
                    await saveEmployees(); // L∆∞u l·∫°i list m·∫∑c ƒë·ªãnh
                }
                populateEmployeeSelect();
                if (isAdmin) {
                    populateAdminEmployeeList();
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i danh s√°ch nh√¢n vi√™n:", error);
                // D√πng danh s√°ch t·∫°m n·∫øu l·ªói
                employees = ['Nguy·ªÖn VƒÉn A (L·ªói t·∫£i)', 'Tr·∫ßn Th·ªã B (L·ªói t·∫£i)'];
                populateEmployeeSelect();
            }
        }
        
        async function saveEmployees() {
            try {
                // L·ªçc b·ªè m·ª•c r·ªóng/tr√πng l·∫∑p v√† s·∫Øp x·∫øp
                const uniqueEmployees = Array.from(new Set(employees.filter(n => n.trim() !== '')));
                employees = uniqueEmployees.sort();
                await db.collection('config').doc('employees').set({ list: employees });
                populateEmployeeSelect();
                if (isAdmin) {
                    populateAdminEmployeeList();
                }
                return true;
            } catch (error) {
                alert('L·ªói khi l∆∞u danh s√°ch nh√¢n vi√™n: ' + error.message);
                return false;
            }
        }
        
        function populateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="" disabled selected>Ch·ªçn t√™n nh√¢n vi√™n...</option>';
            employees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        function populateAdminEmployeeList() {
            const listContainer = document.getElementById('employeeListAdmin');
            listContainer.innerHTML = '';
            employees.forEach(name => {
                const div = document.createElement('div');
                div.className = 'employee-row';
                div.innerHTML = `
                    <span>${name}</span>
                    <button class="btn btn-danger btn-sm" onclick="removeEmployee('${name}')">X√≥a</button>
                `;
                listContainer.appendChild(div);
            });
        }
        
        function addEmployee() {
            const nameInput = document.getElementById('newEmployeeName');
            const name = nameInput.value.trim();
            if (name && !employees.includes(name)) {
                employees.push(name);
                saveEmployees();
                nameInput.value = '';
            } else if (employees.includes(name)) {
                alert('Nh√¢n vi√™n n√†y ƒë√£ c√≥ trong danh s√°ch.');
            } else {
                alert('Vui l√≤ng nh·∫≠p t√™n.');
            }
        }
        
        function removeEmployee(name) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n ${name} kh·ªèi danh s√°ch?`)) {
                employees = employees.filter(n => n !== name);
                saveEmployees();
            }
        }

        // --- X·ª¨ L√ù D·ªÆ LI·ªÜU FIREBASE (saveData, loadDataToForm, loadAdminReportList, deleteReport) ---
        
        function saveData() {
            const date = document.getElementById('selectedDate').value;
            if (!date) {
                alert('Vui l√≤ng ch·ªçn ng√†y.');
                return;
            }

            const expenses = [];
            for (let i = 1; i <= expenseCount; i++) {
                const content = document.getElementById(`expenseContent-${i}`);
                const value = document.getElementById(`expenseValue-${i}`);
                if (content && value) {
                    const numValue = parseCurrency(value.value);
                    if (content.value.trim() || numValue > 0) {
                        expenses.push({
                            content: content.value.trim() || `M·ª•c chi #${i}`,
                            value: numValue
                        });
                    }
                }
            }

            const staffDiscountData = {
                name: document.getElementById('staffName').value,
                bill: parseCurrency(document.getElementById('staffBill').value),
                discount: parseCurrency(document.getElementById('staffDiscount').value)
            };
            
            const data = {
                date: date,
                user: currentUser,
                revenue: parseCurrency(document.getElementById('revenue').value),
                cash: parseCurrency(document.getElementById('cash').value),
                transfer: parseCurrency(document.getElementById('transfer').value),
                shoppeFood: parseCurrency(document.getElementById('shoppeFood').value),
                grabFood: parseCurrency(document.getElementById('grabFood').value),
                beeFood: parseCurrency(document.getElementById('beeFood').value),
                otherIncome: parseCurrency(document.getElementById('otherIncome').value),
                staffDiscount: staffDiscountData,
                expenses: expenses,
                // L∆∞u c√°c gi√° tr·ªã ƒë√£ t√≠nh to√°n:
                totalIncome: parseCurrency(document.getElementById('totalIncome').value),
                totalExpense: parseCurrency(document.getElementById('totalExpense').value),
                totalApps: parseCurrency(document.getElementById('totalApps').value),
                totalIncomeFinal: parseCurrency(document.getElementById('totalIncomeFinalInput').value),
                totalAfterExpenses: parseCurrency(document.getElementById('totalAfterExpensesInput').value), // <--- ADDED totalAfterExpenses
                actualTotal: parseCurrency(document.getElementById('actualTotal').value),
                totalReceived: parseCurrency(document.getElementById('totalReceived').value), 
                timestamp: new Date().toISOString() 
            };

            db.collection('dailyReports').doc(date).set(data)
                .then(() => {
                    document.getElementById('syncStatus').textContent = 'ƒê√£ l∆∞u th√†nh c√¥ng! ‚úÖ';
                    document.getElementById('syncStatus').style.backgroundColor = '#2ecc71';
                    if (isAdmin) {
                        loadAdminReportList(); 
                        document.getElementById('dateSelectAdmin').value = date; 
                    }
                })
                .catch(error => {
                    alert('L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message);
                    console.error('Error saving document: ', error);
                });
        }

        function loadDataToForm(isFromAdmin) {
            const dateInputId = isFromAdmin ? 'dateSelectAdmin' : 'selectedDate';
            const formDateInput = document.getElementById('selectedDate');
            let date = document.getElementById(dateInputId).value;

            if (isFromAdmin) {
                formDateInput.value = date; 
            } else {
                date = formDateInput.value;
            }

            if (!date) return;

            document.getElementById('dataEntryForm').classList.remove('hidden'); 

            document.getElementById('syncStatus').textContent = 'ƒêang t·∫£i... ‚è≥';
            document.getElementById('syncStatus').style.backgroundColor = '#f39c12';
            document.getElementById('clearDateBtn').classList.add('hidden'); 

            db.collection('dailyReports').doc(date).get()
                .then(doc => {
                    resetForm(false); 

                    if (doc.exists) {
                        const data = doc.data();
                        
                        if (isFromAdmin) {
                            document.getElementById('clearDateBtn').classList.remove('hidden');
                        }

                        // ƒêi·ªÅn d·ªØ li·ªáu
                        document.getElementById('revenue').value = formatNumber(data.revenue || 0);
                        document.getElementById('cash').value = formatNumber(data.cash || 0);
                        document.getElementById('transfer').value = formatNumber(data.transfer || 0);
                        document.getElementById('shoppeFood').value = formatNumber(data.shoppeFood || 0);
                        document.getElementById('grabFood').value = formatNumber(data.grabFood || 0);
                        document.getElementById('beeFood').value = formatNumber(data.beeFood || 0);
                        document.getElementById('otherIncome').value = formatNumber(data.otherIncome || 0);
                        
                        if (data.staffDiscount) {
                            document.getElementById('staffName').value = data.staffDiscount.name || '';
                            document.getElementById('staffBill').value = formatNumber(data.staffDiscount.bill || 0);
                            document.getElementById('staffDiscount').value = formatNumber(data.staffDiscount.discount || 0);
                            document.getElementById('staffDiscountAmount').textContent = formatNumber(data.staffDiscount.discount || 0);
                        }

                        const expenseList = document.getElementById('expenseList');
                        expenseList.innerHTML = ''; 
                        expenseCount = 0;
                        if (data.expenses && data.expenses.length > 0) {
                            data.expenses.forEach(item => {
                                addExpenseItem(item.content, item.value, false); 
                            });
                        } else {
                            initExpenseItems();
                        }

                        document.getElementById('syncStatus').textContent = `ƒê√£ t·∫£i d·ªØ li·ªáu th√†nh c√¥ng! (C·∫≠p nh·∫≠t cu·ªëi b·ªüi ${data.user})`;
                        document.getElementById('syncStatus').style.backgroundColor = '#2ecc71';
                        
                        calculateTotals();
                    } else {
                        // Ng√†y ch∆∞a c√≥ d·ªØ li·ªáu
                        resetForm(true);
                        document.getElementById('syncStatus').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu cho ng√†y n√†y. Form ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi.';
                        document.getElementById('syncStatus').style.backgroundColor = '#3498db';
                    }
                })
                .catch(error => {
                    alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
                    console.error('Error loading document: ', error);
                    document.getElementById('syncStatus').textContent = 'L·ªói k·∫øt n·ªëi Firebase ‚ùå';
                    document.getElementById('syncStatus').style.backgroundColor = '#e74c3c';
                });
        }
        
        function loadAdminReportList() {
            if (!isAdmin) return;
            const tbody = document.getElementById('adminReportTableBody');
            tbody.innerHTML = '<tr><td colspan="4">ƒêang t·∫£i...</td></tr>';
            db.collection('dailyReports').orderBy('date', 'desc').get()
                .then(snapshot => {
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="4">Kh√¥ng c√≥ d·ªØ li·ªáu ghi ch√©p n√†o.</td></tr>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString('vi-VN') : 'Kh√¥ng r√µ';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${data.date}</td>
                            <td>${data.user}</td>
                            <td>${timestamp}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewReportAsAdmin('${data.date}')">S·ª≠a</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteReport('${data.date}')">X√≥a</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }
        
        function viewReportAsAdmin(date) {
            document.getElementById('dateSelectAdmin').value = date;
            loadDataToForm(true); 
            document.getElementById('dataEntryForm').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteReport(date) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò ghi ch√©p c·ªßa ng√†y ${date} kh√¥ng?`)) return;
            db.collection('dailyReports').doc(date).delete()
                .then(() => {
                    loadAdminReportList();
                    alert('ƒê√£ x√≥a ghi ch√©p th√†nh c√¥ng.');
                    if (document.getElementById('selectedDate').value === date) {
                        document.getElementById('dataEntryForm').classList.add('hidden');
                        document.getElementById('syncStatus').textContent = 'D·ªØ li·ªáu ƒë√£ b·ªã x√≥a. Vui l√≤ng ch·ªçn ng√†y kh√°c.';
                        document.getElementById('syncStatus').style.backgroundColor = '#e74c3c';
                    }
                })
                .catch(error => {
                    alert('L·ªói khi x√≥a: ' + error.message);
                });
        }
        
        function clearDataForDate() {
            const date = document.getElementById('selectedDate').value;
            if (!date) {
                alert('Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ x√≥a.');
                return;
            }
            deleteReport(date);
        }

        // --- X·ª¨ L√ù LOGIN / LOGOUT ---
        
        function login() {
            const employeeSelect = document.getElementById('employeeSelect');
            currentUser = employeeSelect.value;
            
            if (currentUser) {
                isAdmin = false;
                document.getElementById('loginBlock').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('welcomeMessage').textContent = `Xin ch√†o, Thu ng√¢n ${currentUser}`;
                
                // C·∫•u h√¨nh giao di·ªán Thu ng√¢n
                document.getElementById('adminReportManagement').style.display = 'none';
                document.getElementById('dataEntryForm').classList.remove('hidden');
                document.getElementById('clearDateBtn').classList.add('hidden'); 

                // Thu ng√¢n ch·ªâ ƒë∆∞·ª£c nh·∫≠p ng√†y hi·ªán t·∫°i
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('selectedDate');
                dateInput.value = today;
                dateInput.readOnly = true; 

                loadDataToForm(false); 
            } else {
                alert('Vui l√≤ng ch·ªçn t√™n c·ªßa b·∫°n ƒë·ªÉ ƒëƒÉng nh·∫≠p.');
            }
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) { 
                currentUser = 'ADMIN';
                isAdmin = true;
                document.getElementById('loginBlock').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('welcomeMessage').textContent = `Ch√†o m·ª´ng, Qu·∫£n tr·ªã vi√™n`;
                
                // C·∫•u h√¨nh giao di·ªán Admin
                document.getElementById('adminReportManagement').style.display = 'block';
                document.getElementById('dataEntryForm').classList.add('hidden'); 
                document.getElementById('clearDateBtn').classList.remove('hidden');
                
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('selectedDate');
                dateInput.readOnly = false; 
                dateInput.value = today;
                document.getElementById('dateSelectAdmin').value = today;


                loadAdminReportList();
                populateAdminEmployeeList(); // Hi·ªÉn th·ªã danh s√°ch NV Admin
            } else {
                alert('M·∫≠t kh·∫©u Qu·∫£n tr·ªã vi√™n kh√¥ng ch√≠nh x√°c.');
            }
        }
        
        function logout() {
            window.location.reload();
        }

        // --- H√ÄM XU·∫§T ·∫¢NH / ZALO SHARE (ƒê√£ c·∫≠p nh·∫≠t) ---

        function generateReportImage() {
            const date = document.getElementById('selectedDate').value;
            const reportContent = document.getElementById('reportContent');
            
            const expenses = [];
            for (let i = 1; i <= expenseCount; i++) {
                const contentEl = document.getElementById(`expenseContent-${i}`);
                const valueEl = document.getElementById(`expenseValue-${i}`);
                if (contentEl && valueEl) {
                    const numValue = parseCurrency(valueEl.value);
                    if (contentEl.value.trim() || numValue > 0) {
                        expenses.push({
                            content: contentEl.value.trim() || `M·ª•c chi #${i}`,
                            formattedValue: valueEl.value
                        });
                    }
                }
            }
            
            const staffName = document.getElementById('staffName').value;
            const totalIncomeFinalFormatted = document.getElementById('totalIncomeFinalInput').value;
            const actualTotalFormatted = document.getElementById('actualTotal').value;
            const totalAfterOpeningFormatted = document.getElementById('totalAfterOpening').value;
            const totalAfterExpensesFormatted = document.getElementById('totalAfterExpensesInput').value; 


            let html = `
                <div style="padding: 15px; background: white; max-width: 500px; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px;">
                    <h2 style="text-align: center; color: #3498db; margin-bottom: 15px; font-size: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">B√ÅO C√ÅO THU CHI H√ÄNG NG√ÄY</h2>
                    <div style="margin-bottom: 15px; font-size: 14px; padding: 5px 0; border-bottom: 1px dashed #eee;">
                        <strong>üìÖ Ng√†y:</strong> ${getDayOfWeek(date)}, ${date} 
                    </div>
                    <div style="margin-bottom: 20px; font-size: 14px; padding: 5px 0;">
                        <strong>üë§ Thu ng√¢n:</strong> ${currentUser}
                    </div>
                    
                    <table style="font-size: 14px; width: 100%; border-collapse: collapse;">
                        <tbody>
                            <tr><td colspan="2" style="padding: 8px; background-color: #f7f7f7; font-weight: bold; border-top: 2px solid #3498db; text-align: left;">I. TI·ªÄN THU V√ÄO TRONG CA</td></tr>
                            <tr><td style="padding: 5px 8px;">Ti·ªÅn m·∫∑t (Thu t·ª´ kh√°ch)</td><td style="padding: 5px 8px; text-align: right; font-weight: 500;">${document.getElementById('cash').value}</td></tr>
                            <tr><td style="padding: 5px 8px;">Chuy·ªÉn kho·∫£n (Thu t·ª´ kh√°ch)</td><td style="padding: 5px 8px; text-align: right; font-weight: 500;">${document.getElementById('transfer').value}</td></tr>
                            <tr><td style="padding: 5px 8px;">T·ªïng Apps (Shoppe/Grab/Bee)</td><td style="padding: 5px 8px; text-align: right; font-weight: 500;">${document.getElementById('totalApps').value}</td></tr>
                            <tr><td style="padding: 5px 8px;">Thu kh√°c</td><td style="padding: 5px 8px; text-align: right; font-weight: 500;">${document.getElementById('otherIncome').value}</td></tr>
                            <tr style="background-color: #eaf7ed;"><td style="padding: 8px; font-weight: bold; color: #2ecc71;">T·ªîNG THU (Ti·ªÅn m·∫∑t + Chuy·ªÉn kho·∫£n)</td><td style="padding: 8px; text-align: right; font-weight: bold; color: #2ecc71;">${document.getElementById('totalIncome').value}</td></tr>
                            
                            <tr><td colspan="2" style="padding: 8px; background-color: #f7f7f7; font-weight: bold; border-top: 2px solid #e74c3c; text-align: left;">II. CHI V√Ä GI·∫¢M TR·ª™</td></tr>
                            ${expenses.length > 0 ? expenses.map(item => `<tr><td style="padding: 5px 8px;">Chi: ${item.content}</td><td style="padding: 5px 8px; text-align: right; color: #e74c3c;">-${item.formattedValue}</td></tr>`).join('') : `<tr><td colspan="2" style="padding: 5px 8px; text-align: center; color: #7f8c8d;">(Kh√¥ng c√≥ kho·∫£n chi ti·ªÅn m·∫∑t)</td></tr>`}
                            <tr style="color: #e74c3c;"><td style="padding: 5px 8px;">Gi·∫£m gi√° nh√¢n vi√™n (${staffName || 'Kh√¥ng t√™n'})</td><td style="padding: 5px 8px; text-align: right;">-${document.getElementById('staffDiscount').value}</td></tr>
                            <tr style="background-color: #fcebeb;"><td style="padding: 8px; font-weight: bold; color: #e74c3c;">T·ªîNG CHI TI·ªÄN M·∫∂T</td><td style="padding: 8px; text-align: right; font-weight: bold; color: #e74c3c;">${document.getElementById('totalExpense').value}</td></tr>

                            <tr><td colspan="2" style="padding: 8px; background-color: #f7f7f7; font-weight: bold; border-top: 2px solid #f39c12; text-align: left;">III. T·ªîNG K·∫æT & TI·ªÄN M·∫∂T</td></tr>
                            <tr><td style="padding: 5px 8px; font-weight: 500;">Ti·ªÅn ƒê·∫ßu ca (C·ªë ƒë·ªãnh)</td><td style="padding: 5px 8px; text-align: right; font-weight: 500;">${document.getElementById('openingCash').value}</td></tr>
                            <tr><td style="padding: 5px 8px; font-weight: 500;">T·ªîNG TI·ªÄN M·∫∂T HI·ªÜN C√ì</td><td style="padding: 5px 8px; text-align: right; font-weight: 500;">${totalAfterOpeningFormatted}</td></tr>
                            <tr style="background-color: #d1ecf1;"><td style="padding: 8px; font-weight: bold; color: #0c5460;">T·ªîNG NH·∫¨N T√ÄI KHO·∫¢N (CK + Apps)</td><td style="padding: 8px; text-align: right; font-weight: bold; color: #0c5460;">${document.getElementById('totalReceived').value}</td></tr>
                            
                            <tr style="background-color: #fcebeb; border-top: 2px solid #e74c3c;"><td style="padding: 12px 8px; font-size: 18px; font-weight: bold; color: #e74c3c;">T·ªîNG THU NH·∫¨P</td><td style="padding: 12px 8px; text-align: right; font-size: 18px; font-weight: bold; color: #e74c3c;">${totalIncomeFinalFormatted}</td></tr>
                            
                            <tr style="background-color: #d4edda; border-top: 2px solid #2ecc71;"><td style="padding: 12px 8px; font-size: 18px; font-weight: bold; color: #2ecc71;">T·ªîNG NH·∫¨N SAU C√ÅC CHI PH√ç</td><td style="padding: 12px 8px; text-align: right; font-size: 18px; font-weight: bold; color: #2ecc71;">${totalAfterExpensesFormatted}</td></tr>
                            
                            <tr style="background-color: #fff3cd; border-top: 1px solid #f39c12;"><td style="padding: 10px 8px; font-size: 16px; font-weight: bold; color: #2980b9;">TI·ªÄN M·∫∂T C·∫¶N C√ì (CU·ªêI CA)</td><td style="padding: 10px 8px; text-align: right; font-size: 16px; font-weight: bold; color: #2980b9;">${actualTotalFormatted}</td></tr>
                            
                        </tbody>
                    </table>
                </div>
            `;
            
            reportContent.innerHTML = html;
            
            html2canvas(reportContent, { scale: 2, useCORS: true }).then(canvas => {
                const imageContainer = document.getElementById('exportImageContainer');
                const exportedImage = document.getElementById('exportedImage');
                
                reportContent.classList.add('hidden');
                canvas.id = 'tempCanvas';
                canvas.style.maxWidth = '100%';
                canvas.style.height = 'auto';
                
                const existingCanvas = document.getElementById('tempCanvas');
                if(existingCanvas) existingCanvas.remove();
                
                imageContainer.prepend(canvas);
                
                exportedImage.src = canvas.toDataURL('image/png'); 
                
                imageContainer.classList.remove('hidden');
                
                imageContainer.scrollIntoView({ behavior: 'smooth' });
            });
        }

        function saveAndExport() {
            saveData();
            generateReportImage();
        }
        
        function downloadImage() {
            const exportedImage = document.getElementById('exportedImage');
            const date = document.getElementById('selectedDate').value;
            const fileName = `BaoCaoThuChi_${date}_${currentUser}.png`;

            const a = document.createElement('a');
            a.href = exportedImage.src;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function shareViaZalo() {
            if (!isAdmin) {
                 downloadImage();
                 alert(`‚úÖ ƒê√£ t·∫£i ·∫£nh b√°o c√°o xu·ªëng th∆∞ vi·ªán ·∫£nh c·ªßa b·∫°n!\n\nüîî VUI L√íNG CHUY·ªÇN QUA ZALO v√† g·ª≠i ·∫£nh v·ª´a t·∫£i.`);
                 window.open('https://chat.zalo.me/', '_blank');
            } else {
                 alert('Ch·ª©c nƒÉng chia s·∫ª Zalo ch·ªâ d√†nh cho Nh√¢n vi√™n Thu ng√¢n.');
            }
        }

        function hideExportImage() {
            document.getElementById('exportImageContainer').classList.add('hidden');
            document.getElementById('reportContent').classList.remove('hidden');
            const canvas = document.getElementById('tempCanvas');
            if(canvas) canvas.remove();
        }


        // --- EXCEL EXPORT (ƒê√£ c·∫≠p nh·∫≠t) ---

        function exportReportsByDateRange() {
            if (!isAdmin) return;
            const startDate = document.getElementById('startDateAdmin').value;
            const endDate = document.getElementById('endDateAdmin').value;

            if (!startDate || !endDate) {
                alert('Vui l√≤ng ch·ªçn c·∫£ Ng√†y B·∫Øt ƒê·∫ßu v√† Ng√†y K·∫øt Th√∫c.');
                return;
            }
            if (startDate > endDate) {
                alert('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n Ng√†y k·∫øt th√∫c.');
                return;
            }
            
            document.getElementById('exportBtn').textContent = 'ƒêang t·∫£i...';
            document.getElementById('exportBtn').disabled = true;

            db.collection('dailyReports')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .orderBy('date')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('Kh√¥ng t√¨m th·∫•y b√°o c√°o n√†o trong kho·∫£ng ng√†y ƒë√£ ch·ªçn.');
                        return;
                    }
                    
                    const wb = XLSX.utils.book_new();
                    
                    // 1. D·ªØ li·ªáu cho SHEET T·ªîNG H·ª¢P (Gi√° tr·ªã s·ªë - Excel)
                    const summaryHeader = ['Ng√†y', 'Th·ª©', 'Nh√¢n vi√™n', 'Ti·ªÅn m·∫∑t', 'Chuy·ªÉn kho·∫£n', 'T·ªïng Thu (TM+CK)', 'T·ªïng Chi', 'Gi·∫£m Gi√° NV', 'T·ªïng Gi·∫£m Tr·ª´', 'T·ªïng Apps', 'Thu Kh√°c', 'T·ªîNG THU NH·∫¨P', 'T·ªîNG NH·∫¨N SAU CHI PH√ç'];
                    const summaryData = [summaryHeader];

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const staffDiscountValue = data.staffDiscount ? data.staffDiscount.discount : 0;
                        const totalDeductions = (data.totalExpense || 0); // Gi·∫£m gi√° NV kh√¥ng t√≠nh v√†o Total Deductions

                        summaryData.push([
                            data.date,
                            getDayOfWeek(data.date),
                            data.user,
                            (data.cash || 0),
                            (data.transfer || 0),
                            (data.totalIncome || 0),
                            (data.totalExpense || 0),
                            staffDiscountValue,
                            totalDeductions,
                            (data.totalApps || 0),
                            (data.otherIncome || 0),
                            (data.totalIncomeFinal || 0), // T·ªîNG THU NH·∫¨P (C√¥ng th·ª©c +)
                            (data.totalAfterExpenses || 0) // T·ªîNG NH·∫¨N SAU CHI PH√ç (C√¥ng th·ª©c m·ªõi)
                        ]);

                        // 2. T·∫°o SHEET CHI TI·∫æT cho t·ª´ng ng√†y 
                        const dateData = [
                            ['B√ÅO C√ÅO CHI TI·∫æT NG√ÄY', data.date],
                            ['Thu ng√¢n', data.user],
                            ['', ''],
                            ['KHO·∫¢N M·ª§C', 'S·ªê TI·ªÄN (VNƒê)'],
                            ['I. THU'],
                            ['1. Doanh thu (T·ªïng ti·ªÅn h√†ng)', formatNumber(data.revenue)],
                            ['2. Ti·ªÅn m·∫∑t (Thu t·ª´ kh√°ch)', formatNumber(data.cash)],
                            ['3. Chuy·ªÉn kho·∫£n (Thu t·ª´ kh√°ch)', formatNumber(data.transfer)],
                            ['4. T·ªïng Apps (Shopee, Grab, Bee)', formatNumber(data.totalApps)],
                            ['5. Thu kh√°c', formatNumber(data.otherIncome)],
                            ['=> T·ªîNG THU (Ti·ªÅn m·∫∑t + Chuy·ªÉn kho·∫£n)', formatNumber(data.totalIncome)],
                            ['', ''],
                            ['II. CHI & GI·∫¢M TR·ª™'],
                        ];

                        data.expenses.forEach((item, index) => {
                            dateData.push([`1. Chi ${index + 1}: ${item.content}`, formatNumber(item.value)]);
                        });
                        dateData.push(['=> T·ªîNG CHI TI·ªÄN M·∫∂T', formatNumber(data.totalExpense)]);
                        dateData.push([`2. Gi·∫£m gi√° nh√¢n vi√™n (${data.staffDiscount.name || ''})`, formatNumber(data.staffDiscount.discount)]);

                        dateData.push(['', ''], ['III. T·ªîNG K·∫æT']);
                        dateData.push(['1. ƒê·∫ßu ca', formatNumber(OPENING_CASH)]);
                        dateData.push(['2. T·ªîNG NH·∫¨N T√ÄI KHO·∫¢N (CK + Apps)', formatNumber(data.totalReceived)]);
                        dateData.push(['3. T·ªîNG THU NH·∫¨P', formatNumber(data.totalIncomeFinal)]); 
                        dateData.push(['4. T·ªîNG NH·∫¨N SAU C√ÅC CHI PH√ç', formatNumber(data.totalAfterExpenses)]);
                        dateData.push(['5. TI·ªÄN M·∫∂T C·∫¶N C√ì (CU·ªêI CA)', formatNumber(data.actualTotal)]); 

                        const dateSheet = XLSX.utils.aoa_to_sheet(dateData);
                        dateSheet['!cols'] = [{ wch: 40 }, { wch: 20 }];
                        XLSX.utils.book_append_sheet(wb, dateSheet, data.date);
                    });
                    
                    // Th√™m Sheet T·ªîNG H·ª¢P v√†o ƒë·∫ßu ti√™n
                    const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                    summarySheet['!cols'] = [
                        { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, 
                        { wch: 18 }, { wch: 15 }, { wch: 15 }, { wch: 18 }, { wch: 15 }, 
                        { wch: 15 }, { wch: 20 }, { wch: 20 } 
                    ];
                    XLSX.utils.book_append_sheet(wb, summarySheet, 'T·ªîNG H·ª¢P');
                    wb.SheetNames.unshift(wb.SheetNames.pop());


                    XLSX.writeFile(wb, `Bao_Cao_Tong_Hop_${startDate}_den_${endDate}.xlsx`);
                    alert('ƒê√£ xu·∫•t b√°o c√°o Excel th√†nh c√¥ng.');
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('L·ªói khi xu·∫•t Excel: ' + error.message);
                })
                .finally(() => {
                    document.getElementById('exportBtn').textContent = 'T·∫£i b√°o c√°o Excel';
                    document.getElementById('exportBtn').disabled = false;
                });
        }
        
        // --- KH·ªûI T·∫†O ---
        
        function resetForm(resetExpense = true) {
            const inputs = document.querySelectorAll('#dataEntryForm input[type="text"]');
            inputs.forEach(input => {
                if (input.id !== 'openingCash') { 
                    input.value = '0';
                }
            });
            document.getElementById('staffName').value = '';
            document.getElementById('staffDiscountAmount').textContent = '0';
            
            if(resetExpense) {
                initExpenseItems();
            }
            calculateTotals();
        }
        
        window.onload = function() {
            loadEmployees(); // T·∫£i danh s√°ch nh√¢n vi√™n t·ª´ Firebase
        };
        

    </script>
</body>
</html>